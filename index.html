<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Tejidos al Crochet</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary-color: #ffb6c1;
            --secondary-color: #f8e1e5;
            --accent-color: #d4a5a5;
            --text-color: #5a3e36;
            --light-color: #fff9fb;
            --delete-color: #e74c3c;
            --filter-color: #7fb174;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--light-color);
            color: var(--text-color);
            line-height: 1.6;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
            padding: 2rem 0;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .form-container {
            background-color: white;
            border-radius: 10px;
            padding: 2rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .image-preview {
            width: 100%;
            max-width: 300px;
            height: 200px;
            border: 2px dashed var(--accent-color);
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 1rem;
            overflow: hidden;
        }
        
        .image-preview img {
            width: auto;
            height: auto;
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .compression-info {
            font-size: 0.8rem;
            color: #666;
            margin-top: 0.5rem;
            padding: 0.5rem;
            background-color: #f0f8f0;
            border-radius: 4px;
            border-left: 4px solid #7fb174;
        }
        
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: background-color 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        button:hover {
            background-color: var(--accent-color);
        }
        
        .export-btn {
            background-color: #7fb174;
        }
        
        .export-btn:hover {
            background-color: #6a9c5f;
        }
        
        .delete-btn {
            background-color: var(--delete-color);
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            margin-top: 10px;
        }
        
        .delete-btn:hover {
            background-color: #c0392b;
        }
        
        .filter-btn {
            background-color: var(--filter-color);
        }
        
        .filter-btn:hover {
            background-color: #6a9c5f;
        }
        
        .records-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        
        .filters-container {
            background-color: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
            display: none;
        }
        
        .filters-container.active {
            display: block;
        }
        
        .filter-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .tag {
            background-color: var(--secondary-color);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .tag:hover {
            background-color: var(--primary-color);
        }
        
        .tag.active {
            background-color: var(--filter-color);
            color: white;
        }
        
        .records-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 2rem;
        }
        
        .record-card {
            background-color: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        .record-card:hover {
            transform: translateY(-5px);
        }
        
        .record-image-container {
            width: 100%;
            height: 200px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f9f9f9;
        }
        
        .record-image {
            width: auto;
            height: auto;
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .record-details {
            padding: 1.5rem;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        
        .record-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-color);
        }
        
        .record-info {
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        
        .record-price {
            font-weight: 600;
            color: var(--accent-color);
            font-size: 1.1rem;
            margin-top: auto;
            padding-top: 1rem;
        }
        
        .record-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .record-tag {
            background-color: var(--secondary-color);
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #888;
            grid-column: 1 / -1;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 1rem;
            color: #7fb174;
            font-weight: bold;
        }
        
        .debug-info {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 1rem;
            margin-top: 1rem;
            font-size: 0.9rem;
            color: #666;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .form-container {
                padding: 1.5rem;
            }
            
            .records-container {
                grid-template-columns: 1fr;
            }
            
            .records-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .records-header h2 {
                margin-bottom: 1rem;
            }
            
            .records-header .buttons {
                display: flex;
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>Registro de Tejidos al Crochet</h1>
        <p>Organiza y registra tus creaciones de tejido</p>
    </header>
    
    <div class="container">
        <div class="form-container">
            <h2>Agregar Nuevo Tejido</h2>
            <form id="crochet-form">
                <div class="form-group">
                    <label for="title">TÃ­tulo / Nombre del amigurumi o tejido *</label>
                    <input type="text" id="title" required>
                </div>
                
                <div class="form-group">
                    <label for="date">Fecha *</label>
                    <input type="date" id="date" required>
                </div>
                
                <div class="form-group">
                    <label for="needle-type">Tipo de aguja *</label>
                    <select id="needle-type" required>
                        <option value="">Selecciona un tipo</option>
                        <option value="2.0 mm">2.0 mm</option>
                        <option value="2.5 mm">2.5 mm</option>
                        <option value="3.0 mm">3.0 mm</option>
                        <option value="3.5 mm">3.5 mm</option>
                        <option value="4.0 mm">4.0 mm</option>
                        <option value="4.5 mm">4.5 mm</option>
                        <option value="5.0 mm">5.0 mm</option>
                        <option value="5.5 mm">5.5 mm</option>
                        <option value="6.0 mm">6.0 mm</option>
                        <option value="Otro">Otro</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="pattern">PatrÃ³n</label>
                    <textarea id="pattern" placeholder="Describe el patrÃ³n utilizado..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="source">Donde encontrarlo</label>
                    <input type="text" id="source" placeholder="URL, libro, etc.">
                </div>
                
                <div class="form-group">
                    <label for="measurements">Medidas</label>
                    <input type="text" id="measurements" placeholder="Ej: 15cm x 20cm">
                </div>
                
                <div class="form-group">
                    <label for="accessories">Accesorios</label>
                    <input type="text" id="accessories" placeholder="Ojos, ropa, etc.">
                </div>
                
                <div class="form-group">
                    <label for="weight">Peso</label>
                    <input type="text" id="weight" placeholder="Ej: 150g">
                </div>
                
                <div class="form-group">
                    <label for="price">Precio</label>
                    <input type="number" id="price" min="0" step="0.01" placeholder="0.00">
                </div>
                
                <div class="form-group">
                    <label for="tags">Etiquetas (separadas por comas)</label>
                    <input type="text" id="tags" placeholder="Ej: amigurumi, animal, regalo, venta">
                </div>
                
                <div class="form-group">
                    <label for="photo">Foto del producto</label>
                    <input type="file" id="photo" accept="image/*">
                    <div class="image-preview" id="image-preview">
                        <span>Vista previa de la imagen</span>
                    </div>
                    <div class="compression-info" id="compression-info">
                        â Las imÃ¡genes se comprimen automÃ¡ticamente para ahorrar espacio
                    </div>
                </div>
                
                <button type="submit" id="submit-btn">Guardar Registro</button>
                
                <div class="debug-info" id="debug-info" style="display: none;">
                    <!-- InformaciÃ³n de depuraciÃ³n -->
                </div>
            </form>
        </div>
        
        <div class="records-header">
            <h2>Registros Guardados</h2>
            <div class="buttons">
                <button class="filter-btn" id="toggle-filters">Filtrar por Etiquetas</button>
                <button class="export-btn" id="export-pdf">Exportar a PDF con Fotos</button>
            </div>
        </div>
        
        <div class="filters-container" id="filters-container">
            <h3>Filtrar por etiquetas:</h3>
            <div class="filter-tags" id="filter-tags">
                <!-- Las etiquetas se generarÃ¡n automÃ¡ticamente aquÃ­ -->
            </div>
            <button class="filter-btn" id="clear-filters" style="margin-top: 1rem;">Limpiar Filtros</button>
        </div>
        
        <div class="loading" id="loading">Generando PDF con fotos, por favor espere...</div>
        
        <div class="records-container" id="records-container">
            <div class="empty-state" id="empty-state">
                <p>No hay registros guardados aÃºn. Â¡Agrega tu primer tejido!</p>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Establecer la fecha actual como valor predeterminado
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;
            
            // Elementos del DOM
            const photoInput = document.getElementById('photo');
            const imagePreview = document.getElementById('image-preview');
            const form = document.getElementById('crochet-form');
            const submitBtn = document.getElementById('submit-btn');
            const recordsContainer = document.getElementById('records-container');
            const emptyState = document.getElementById('empty-state');
            const exportPdfBtn = document.getElementById('export-pdf');
            const loadingElement = document.getElementById('loading');
            const toggleFiltersBtn = document.getElementById('toggle-filters');
            const filtersContainer = document.getElementById('filters-container');
            const filterTagsContainer = document.getElementById('filter-tags');
            const clearFiltersBtn = document.getElementById('clear-filters');
            const debugInfo = document.getElementById('debug-info');
            const compressionInfo = document.getElementById('compression-info');
            
            let activeFilters = [];
            
            // FunciÃ³n para comprimir imagen
            function compressImage(file, callback) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // TamaÃ±o mÃ¡ximo para imÃ¡genes (800px en el lado mÃ¡s largo)
                        const MAX_SIZE = 800;
                        let width = img.width;
                        let height = img.height;
                        
                        // Redimensionar manteniendo la relaciÃ³n de aspecto
                        if (width > height && width > MAX_SIZE) {
                            height = (height * MAX_SIZE) / width;
                            width = MAX_SIZE;
                        } else if (height > MAX_SIZE) {
                            width = (width * MAX_SIZE) / height;
                            height = MAX_SIZE;
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        // Dibujar imagen redimensionada
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Comprimir a JPEG con calidad del 70%
                        const compressedBase64 = canvas.toDataURL('image/jpeg', 0.7);
                        
                        // Calcular reducciÃ³n de tamaÃ±o
                        const originalSize = file.size;
                        const compressedSize = Math.round((compressedBase64.length * 3) / 4); // AproximaciÃ³n Base64
                        const reduction = Math.round((1 - compressedSize / originalSize) * 100);
                        
                        // Mostrar informaciÃ³n de compresiÃ³n
                        compressionInfo.innerHTML = `
                            â Imagen comprimida: 
                            De ${(originalSize / 1024).toFixed(0)}KB a ${(compressedSize / 1024).toFixed(0)}KB 
                            (${reduction}% de reducciÃ³n)
                        `;
                        
                        callback(compressedBase64);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
            
            // FunciÃ³n para mostrar informaciÃ³n de depuraciÃ³n
            function showDebugInfo(message) {
                debugInfo.style.display = 'block';
                debugInfo.innerHTML = `<strong>DepuraciÃ³n:</strong> ${message}`;
                console.log(message);
            }
            
            // Vista previa de imagen
            photoInput.addEventListener('change', function() {
                const file = this.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        imagePreview.innerHTML = `<img src="${e.target.result}" alt="Vista previa">`;
                        compressionInfo.innerHTML = 'â Las imÃ¡genes se comprimen automÃ¡ticamente para ahorrar espacio';
                    }
                    reader.readAsDataURL(file);
                } else {
                    imagePreview.innerHTML = '<span>Vista previa de la imagen</span>';
                }
            });
            
            // Manejar el envÃ­o del formulario
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                submitBtn.disabled = true;
                submitBtn.textContent = 'Guardando...';
                
                showDebugInfo('Iniciando proceso de guardado...');
                
                try {
                    // Obtener valores del formulario
                    const title = document.getElementById('title').value;
                    const date = document.getElementById('date').value;
                    const needleType = document.getElementById('needle-type').value;
                    const pattern = document.getElementById('pattern').value;
                    const source = document.getElementById('source').value;
                    const measurements = document.getElementById('measurements').value;
                    const accessories = document.getElementById('accessories').value;
                    const weight = document.getElementById('weight').value;
                    const price = document.getElementById('price').value;
                    const tagsInput = document.getElementById('tags').value;
                    const photo = document.getElementById('photo').files[0];
                    
                    showDebugInfo(`Datos capturados: ${title}, ${date}, ${needleType}`);
                    
                    // Validaciones bÃ¡sicas
                    if (!title || !date || !needleType) {
                        throw new Error('Por favor completa los campos obligatorios (*)');
                    }
                    
                    // Procesar etiquetas
                    const tags = tagsInput.split(',').map(tag => tag.trim()).filter(tag => tag !== '');
                    
                    // Si hay foto, comprimirla
                    if (photo) {
                        showDebugInfo('Comprimiendo imagen...');
                        compressImage(photo, function(compressedImage) {
                            try {
                                const record = createRecord(title, date, needleType, pattern, source, 
                                                          measurements, accessories, weight, price, 
                                                          tags, compressedImage);
                                saveRecord(record);
                                showSuccess();
                            } catch (error) {
                                showError(error.message);
                            }
                        });
                    } else {
                        // Sin foto
                        showDebugInfo('Guardando sin imagen...');
                        const record = createRecord(title, date, needleType, pattern, source, 
                                                  measurements, accessories, weight, price, 
                                                  tags, null);
                        saveRecord(record);
                        showSuccess();
                    }
                } catch (error) {
                    showError(error.message);
                }
            });
            
            // FunciÃ³n para crear objeto de registro
            function createRecord(title, date, needleType, pattern, source, measurements, 
                                accessories, weight, price, tags, photo) {
                return {
                    id: Date.now(),
                    title,
                    date,
                    needleType,
                    pattern,
                    source,
                    measurements,
                    accessories,
                    weight,
                    price,
                    tags,
                    photo: photo
                };
            }
            
            // FunciÃ³n para guardar registro
            function saveRecord(record) {
                showDebugInfo('Guardando en localStorage...');
                let records = JSON.parse(localStorage.getItem('crochetRecords')) || [];
                records.push(record);
                localStorage.setItem('crochetRecords', JSON.stringify(records));
                showDebugInfo('Registro guardado exitosamente');
            }
            
            // FunciÃ³n para mostrar Ã©xito
            function showSuccess() {
                showDebugInfo('Proceso completado exitosamente');
                alert('Â¡Registro guardado correctamente!');
                
                // Actualizar la vista
                displayRecords();
                updateFilterTags();
                
                // Limpiar formulario
                form.reset();
                imagePreview.innerHTML = '<span>Vista previa de la imagen</span>';
                document.getElementById('date').value = today;
                compressionInfo.innerHTML = 'â Las imÃ¡genes se comprimen automÃ¡ticamente para ahorrar espacio';
                
                // Restaurar botÃ³n
                submitBtn.disabled = false;
                submitBtn.textContent = 'Guardar Registro';
                
                // Ocultar informaciÃ³n de depuraciÃ³n despuÃ©s de 5 segundos
                setTimeout(() => {
                    debugInfo.style.display = 'none';
                }, 5000);
            }
            
            // FunciÃ³n para mostrar error
            function showError(message) {
                showDebugInfo(`ERROR: ${message}`);
                alert(`Error: ${message}`);
                
                // Restaurar botÃ³n
                submitBtn.disabled = false;
                submitBtn.textContent = 'Guardar Registro';
            }
            
            // FunciÃ³n para eliminar registro
            function deleteRecord(id) {
                if (confirm('Â¿EstÃ¡s segura de que quieres eliminar este registro?')) {
                    let records = JSON.parse(localStorage.getItem('crochetRecords')) || [];
                    records = records.filter(record => record.id !== id);
                    localStorage.setItem('crochetRecords', JSON.stringify(records));
                    displayRecords();
                    updateFilterTags();
                }
            }
            
            // FunciÃ³n para mostrar registros
            function displayRecords() {
                const records = JSON.parse(localStorage.getItem('crochetRecords')) || [];
                let filteredRecords = records;
                
                // Aplicar filtros si hay activos
                if (activeFilters.length > 0) {
                    filteredRecords = records.filter(record => {
                        return activeFilters.some(filter => 
                            record.tags && record.tags.includes(filter)
                        );
                    });
                }
                
                if (filteredRecords.length === 0) {
                    emptyState.style.display = 'block';
                    emptyState.innerHTML = activeFilters.length > 0 
                        ? '<p>No hay registros que coincidan con los filtros seleccionados.</p>'
                        : '<p>No hay registros guardados aÃºn. Â¡Agrega tu primer tejido!</p>';
                    return;
                }
                
                emptyState.style.display = 'none';
                recordsContainer.innerHTML = '';
                
                filteredRecords.forEach((record) => {
                    const recordCard = document.createElement('div');
                    recordCard.className = 'record-card';
                    
                    recordCard.innerHTML = `
                        <div class="record-image-container">
                            ${record.photo ? `<img src="${record.photo}" alt="${record.title}" class="record-image">` : 
                            '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#888;">Sin imagen</div>'}
                        </div>
                        <div class="record-details">
                            <h3 class="record-title">${record.title}</h3>
                            <p class="record-info"><strong>Fecha:</strong> ${formatDate(record.date)}</p>
                            <p class="record-info"><strong>Aguja:</strong> ${record.needleType}</p>
                            ${record.pattern ? `<p class="record-info"><strong>PatrÃ³n:</strong> ${record.pattern}</p>` : ''}
                            ${record.source ? `<p class="record-info"><strong>Fuente:</strong> ${record.source}</p>` : ''}
                            ${record.measurements ? `<p class="record-info"><strong>Medidas:</strong> ${record.measurements}</p>` : ''}
                            ${record.accessories ? `<p class="record-info"><strong>Accesorios:</strong> ${record.accessories}</p>` : ''}
                            ${record.weight ? `<p class="record-info"><strong>Peso:</strong> ${record.weight}</p>` : ''}
                            ${record.price ? `<p class="record-price">Precio: $${parseFloat(record.price).toFixed(2)}</p>` : ''}
                            ${record.tags && record.tags.length > 0 ? `
                                <div class="record-tags">
                                    ${record.tags.map(tag => `<span class="record-tag">${tag}</span>`).join('')}
                                </div>
                            ` : ''}
                            <button class="delete-btn" data-id="${record.id}">Eliminar</button>
                        </div>
                    `;
                    
                    recordsContainer.appendChild(recordCard);
                });
                
                // Agregar event listeners a los botones de eliminar
                document.querySelectorAll('.delete-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const id = parseInt(this.getAttribute('data-id'));
                        deleteRecord(id);
                    });
                });
            }
            
            // FunciÃ³n para actualizar las etiquetas de filtro
            function updateFilterTags() {
                const records = JSON.parse(localStorage.getItem('crochetRecords')) || [];
                const allTags = new Set();
                
                // Recopilar todas las etiquetas Ãºnicas
                records.forEach(record => {
                    if (record.tags) {
                        record.tags.forEach(tag => allTags.add(tag));
                    }
                });
                
                // Limpiar contenedor de etiquetas
                filterTagsContainer.innerHTML = '';
                
                // Agregar etiquetas al contenedor
                allTags.forEach(tag => {
                    const tagElement = document.createElement('div');
                    tagElement.className = `tag ${activeFilters.includes(tag) ? 'active' : ''}`;
                    tagElement.textContent = tag;
                    tagElement.addEventListener('click', function() {
                        toggleFilter(tag);
                    });
                    filterTagsContainer.appendChild(tagElement);
                });
            }
            
            // FunciÃ³n para alternar filtros
            function toggleFilter(tag) {
                if (activeFilters.includes(tag)) {
                    activeFilters = activeFilters.filter(t => t !== tag);
                } else {
                    activeFilters.push(tag);
                }
                displayRecords();
                updateFilterTags();
            }
            
            // FunciÃ³n para formatear fecha
            function formatDate(dateString) {
                const options = { year: 'numeric', month: 'long', day: 'numeric' };
                return new Date(dateString).toLocaleDateString('es-ES', options);
            }
            
            // Event listeners para filtros
            toggleFiltersBtn.addEventListener('click', function() {
                filtersContainer.classList.toggle('active');
            });
            
            clearFiltersBtn.addEventListener('click', function() {
                activeFilters = [];
                displayRecords();
                updateFilterTags();
            });
            
            // FunciÃ³n para exportar a PDF CON FOTOS
            exportPdfBtn.addEventListener('click', async function() {
                loadingElement.style.display = 'block';
                loadingElement.textContent = 'Generando PDF con fotos, por favor espere...';
                
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    const records = JSON.parse(localStorage.getItem('crochetRecords')) || [];
                    
                    if (records.length === 0) {
                        doc.setFontSize(12);
                        doc.text('No hay registros guardados.', 20, 30);
                        doc.save('registro_tejidos.pdf');
                        loadingElement.style.display = 'none';
                        return;
                    }
                    
                    // ConfiguraciÃ³n de la pÃ¡gina
                    const pageWidth = doc.internal.pageSize.getWidth();
                    const margin = 20;
                    const contentWidth = pageWidth - (2 * margin);
                    
                    // TÃ­tulo del documento
                    doc.setFontSize(20);
                    doc.setTextColor(40, 40, 40);
                    doc.text('CatÃ¡logo de Tejidos al Crochet', pageWidth / 2, 20, { align: 'center' });
                    
                    // Fecha de generaciÃ³n
                    doc.setFontSize(10);
                    doc.setTextColor(100, 100, 100);
                    doc.text(`Generado el: ${new Date().toLocaleDateString('es-ES')}`, pageWidth - margin, 15, { align: 'right' });
                    
                    let yPosition = 40;
                    let recordCount = 0;
                    
                    for (let i = 0; i < records.length; i++) {
                        const record = records[i];
                        
                        // Verificar si necesitamos nueva pÃ¡gina
                        if (yPosition > 250 && i > 0) {
                            doc.addPage();
                            yPosition = 20;
                            
                            // TÃ­tulo en pÃ¡ginas adicionales
                            doc.setFontSize(16);
                            doc.setTextColor(40, 40, 40);
                            doc.text('CatÃ¡logo de Tejidos al Crochet (continuaciÃ³n)', pageWidth / 2, 15, { align: 'center' });
                            yPosition = 30;
                        }
                        
                        // Actualizar estado de carga
                        loadingElement.textContent = `Generando PDF... (${i + 1}/${records.length})`;
                        
                        // Fondo de la tarjeta
                        doc.setFillColor(255, 255, 255);
                        doc.rect(margin - 5, yPosition - 5, contentWidth + 10, 80, 'F');
                        doc.setDrawColor(200, 200, 200);
                        doc.rect(margin - 5, yPosition - 5, contentWidth + 10, 80, 'S');
                        
                        // TÃ­tulo del tejido
                        doc.setFontSize(14);
                        doc.setTextColor(90, 62, 54); // Color del texto principal
                        doc.text(record.title, margin, yPosition);
                        yPosition += 7;
                        
                        // InformaciÃ³n en dos columnas
                        const col1X = margin;
                        const col2X = margin + contentWidth / 2;
                        
                        doc.setFontSize(9);
                        doc.setTextColor(80, 80, 80);
                        
                        // Columna 1: InformaciÃ³n bÃ¡sica
                        doc.text(`Fecha: ${formatDate(record.date)}`, col1X, yPosition);
                        doc.text(`Aguja: ${record.needleType}`, col1X, yPosition + 5);
                        
                        if (record.measurements) {
                            doc.text(`Medidas: ${record.measurements}`, col1X, yPosition + 10);
                        }
                        
                        if (record.weight) {
                            doc.text(`Peso: ${record.weight}`, col1X, yPosition + 15);
                        }
                        
                        if (record.price) {
                            doc.setFontSize(10);
                            doc.setTextColor(212, 165, 165); // Color de acento
                            doc.text(`Precio: $${parseFloat(record.price).toFixed(2)}`, col1X, yPosition + 22);
                            doc.setFontSize(9);
                            doc.setTextColor(80, 80, 80);
                        }
                        
                        // Columna 2: InformaciÃ³n adicional
                        if (record.pattern) {
                            const patternLines = doc.splitTextToSize(`PatrÃ³n: ${record.pattern}`, contentWidth / 2 - 10);
                            doc.text(patternLines, col2X, yPosition);
                            yPosition += patternLines.length * 3.5;
                        }
                        
                        if (record.source) {
                            const sourceLines = doc.splitTextToSize(`Fuente: ${record.source}`, contentWidth / 2 - 10);
                            doc.text(sourceLines, col2X, yPosition);
                            yPosition += sourceLines.length * 3.5;
                        }
                        
                        if (record.accessories) {
                            doc.text(`Accesorios: ${record.accessories}`, col2X, yPosition);
                            yPosition += 5;
                        }
                        
                        // Etiquetas
                        if (record.tags && record.tags.length > 0) {
                            doc.text(`Etiquetas: ${record.tags.join(', ')}`, margin, yPosition + 5);
                        }
                        
                        // IMAGEN - Si existe
                        if (record.photo) {
                            try {
                                const img = new Image();
                                img.src = record.photo;
                                
                                await new Promise((resolve, reject) => {
                                    img.onload = resolve;
                                    img.onerror = reject;
                                    // Timeout por seguridad
                                    setTimeout(resolve, 1000);
                                });
                                
                                // TamaÃ±o de la imagen en el PDF
                                const imgWidth = 30;
                                const imgHeight = 30;
                                const imgX = pageWidth - margin - imgWidth - 5;
                                const imgY = yPosition - 40;
                                
                                // Agregar imagen al PDF
                                doc.addImage(img, 'JPEG', imgX, imgY, imgWidth, imgHeight);
                                
                                // Marco alrededor de la imagen
                                doc.setDrawColor(180, 180, 180);
                                doc.rect(imgX - 1, imgY - 1, imgWidth + 2, imgHeight + 2, 'S');
                                
                            } catch (error) {
                                console.warn('No se pudo cargar la imagen para el PDF:', error);
                                // Continuar sin imagen
                            }
                        }
                        
                        yPosition += 45;
                        recordCount++;
                        
                        // LÃ­nea separadora entre registros
                        if (i < records.length - 1) {
                            doc.setDrawColor(220, 220, 220);
                            doc.line(margin, yPosition - 10, pageWidth - margin, yPosition - 10);
                        }
                    }
                    
                    // Pie de pÃ¡gina
                    const totalPages = doc.internal.getNumberOfPages();
                    for (let i = 1; i <= totalPages; i++) {
                        doc.setPage(i);
                        doc.setFontSize(8);
                        doc.setTextColor(150, 150, 150);
                        doc.text(`PÃ¡gina ${i} de ${totalPages} - ${recordCount} registros`, pageWidth / 2, doc.internal.pageSize.getHeight() - 10, { align: 'center' });
                    }
                    
                    // Guardar el PDF
                    doc.save(`catalogo_tejidos_${new Date().toISOString().split('T')[0]}.pdf`);
                    
                    loadingElement.textContent = 'Â¡PDF generado exitosamente!';
                    setTimeout(() => {
                        loadingElement.style.display = 'none';
                    }, 2000);
                    
                } catch (error) {
                    console.error('Error al generar PDF:', error);
                    loadingElement.textContent = 'Error al generar el PDF. Intenta nuevamente.';
                    setTimeout(() => {
                        loadingElement.style.display = 'none';
                    }, 3000);
                }
            });
            
            // Mostrar registros al cargar la pÃ¡gina
            displayRecords();
            updateFilterTags();
            
            showDebugInfo('AplicaciÃ³n cargada correctamente. Las imÃ¡genes se comprimen automÃ¡ticamente.');
        });
    </script>
</body>
</html>